{% liquid
  assign c = "ProductCard"
  assign product = product
  assign collection = collection | default: false
  assign no_color_filters_active = no_color_filters_active | default: false
  assign quick_shop_enabled = quick_shop_enabled | default: false
  assign lifestyle_images_enabled = lifestyle_images_enabled | default: false
  assign variant_override_collection = variant_override_collection | default: false
  assign modifiers = modifiers | default: ''
  assign product_quick_shop_disabled = product.metafields.custom.disable_quick_add | default: false
  assign options_count = product.options | size
  assign hidden_options = settings.product_variant_values_to_hide | split: ","
  assign is_homeware = false
  assign force_variant = force_variant | default: false

  if product.template_suffix == 'homeware'
    assign is_homeware = true
  endif

  assign featured_option = 'option2'
  if product.tags contains 'product-swatches-option-3'
    assign featured_option = 'option3'
  endif
  if is_homeware
    assign featured_option = 'option1'
  endif

  assign current_variant = product.selected_or_first_available_variant
  assign selected_variant_id = product.metafields.featured_variant.variant_id | default: false
  if selected_variant_id
    assign selected_variant_id = selected_variant_id | plus: 0
  endif
  assign selected_variant_color = product.metafields.featured_variant.variant_color | default: false
  assign variant_overrides = product.metafields.featured_variant.variant_overrides | default: false
  assign variant_override = false

  if variant_overrides
    assign variant_overrides = variant_overrides | remove: '"' | remove: ']' | remove: '['
    assign variant_overrides = variant_overrides | split: ','

    for override in variant_overrides
      assign override_formatted = override | split: '/'
      assign target = override_formatted | first

      if target == collection.handle or target == variant_override_collection.handle or target == page.handle
        assign variant_override = override_formatted | last | downcase
      endif
    endfor
  endif

  for variant in product.variants
    assign show_variant = true
    for option in hidden_options
      if option == variant[featured_option]
        assign show_variant = false
      endif
    endfor

    if variant_override and no_color_filters_active
      assign color_title = variant[featured_option] | downcase
      if color_title == variant_override and variant.available and show_variant
        assign current_variant = variant
        break
      endif

    elsif selected_variant_id
      if variant.id == selected_variant_id and variant.available
        assign current_variant = variant
        break
      endif

    elsif selected_variant_color and no_color_filters_active
      assign color_title = variant[featured_option] | downcase
      assign selected_variant_color = selected_variant_color | downcase

      if color_title == selected_variant_color and variant.available and show_variant
        assign current_variant = variant
        break
      endif

    endif
  endfor

  if force_variant and no_color_filters_active
    assign current_variant = force_variant
  endif

  assign color_options = false
  assign color_option_names = 'hue'
  for option in product.options_with_values
    assign cased_option_name = option.name | downcase
    if cased_option_name contains 'color' or color_option_names contains cased_option_name
      assign color_options = option
      break
    endif
  endfor

  assign featured_image = product.featured_image
  if current_variant.featured_image
    assign featured_image = current_variant.featured_image
  endif

  assign url = current_variant.url

  assign text_alignment_class = ''
  if color_options == false
    assign text_alignment_class = c | append: "--no-color-options"
  endif

  if product_quick_shop_disabled
    assign quick_shop_enabled = false
  endif
%}

<article
  class="{{c}} {{ text_alignment_class }} js-productCard-{{ product.id }} {{ modifiers }}"
  data-component="{{c}}"
  data-product-id="{{ product.id }}"
>

  <a
    class="{{c}}__image-link js-productCardLink"
    href="{{ url }}"
  >
    <div class="{{c}}__top">

      <div class="{{c}}__top-left">
        {%
          render 'product-card-badge',
          tags: product.tags
        %}

        {% render 'product-card-wishlist-btn'
          product: product,
          current_variant: current_variant
        %}
      </div>

      {%
        render 'product-card-rating',
        field: product.metafields.okendo.ProductListingSnippet
      %}
    </div>

    {%
      render 'product-card-images',
      featured_image: featured_image,
      images: product.images,
      media: product.media,
      lifestyle_images_enabled: lifestyle_images_enabled,
    %}
  </a>

  <div class="{{c}}__details-wrap">
    <div class="{{c}}__details">
      
      <a
        class="{{c}}__text-link {{c}}__info-wrap js-productCardLink"
        href="{{ url }}"
      >
        <div class="{{c}}__info-top">
          <div class="{{c}}__title body-s">
            {{ product.title }}
          </div>
  
          <div class="{{c}}__price-desktop">
            {%
              render 'product-card-price',
              product: product,
              current_variant: current_variant,
              show_quick_shop: quick_shop_enabled,
            %}
          </div>
        </div>

        {% unless product.has_only_default_variant %}
          <div class="{{c}}__selected-options">
            {% for option in product.options_with_values limit: 2 %}
              {% liquid
                assign is_color_option = false
  
                if color_options and option.name == color_options.name
                  assign is_color_option = true
                endif
              %}
              
              {% if is_color_option %}
                <span class="caption js-productCardColor">
                  {{ current_variant[featured_option] }}
                </span>
  
              {% else %}
                <span class="caption">
                  {{ option.selected_value }}
                </span>
              {% endif %}
            {% endfor %}
          </div>
        {% endunless %}
      </a>
  
      {% if color_options and product.available %}
        <div class="{{c}}__swatch-wrap">
          {% if options_count > 2 %}
            {%
              render 'product-card-swatches-options',
              options: color_options,
              variants: product.variants,
              current_variant: current_variant,
              featured_option: featured_option,
              collection: collection,
            %}
          {% else %}
            {%
              render 'product-card-swatches',
              variants: product.variants,
              current_variant: current_variant
              featured_option: featured_option,
              collection: collection,
            %}
          {% endif %}
        </div>
      {% endif %}
  
      <a 
        class="{{c}}__price-mobile js-productCardLink"
        href="{{ url }}" 
      >
        {%
          render 'product-card-price',
          product: product,
          current_variant: current_variant,
          show_quick_shop: quick_shop_enabled,
        %}
      </a>
    </div>
    
    {% if quick_shop_enabled %}
      {%
        render 'product-card-quick-shop-button',
        handle: product.handle,
        current_variant: current_variant,
        variant_sku: current_variant.sku,
        product_title: product.title
      %}
    {% endif %}
  </div>
</article>
